# KiCad Tools

This directory contains scripts related to [KiCad](www.kicad.org) PCB import to [OpenPnP](www.openpnp.org).

## kicad-to-openpnp-standalone.py

This script will read a [KiCad](www.kicad.org) PCB file generated by PCBNew to create
an [OpenPnP](www.openpnp.org) board.xml file and optionally generate parts and
packages definitions.

### Usage

The minimal command line to use is: `python3 ./kicad-to-openpnp-standalone.py --board foo.kicad_pcb --board_xml foo.board.xml`.
This instructs the utility to load `foo.kicad_pcb` and generate `foo.board.xml`, note that it will also
modify the [OpenPnP](www.openpnp.org) parts and packages definitions.

> **Note**
> OpenPnP should *NOT* be running when using this utility. If OpenPnP is running parts and package definitions may not preserved.

> **Note**
> If you see errors with missing KiCad python bindings, you may need to run this tool from with a KiCad Python shell.

> **Note**
> If you see errors related to packaging.version you may need to install the package via `pip install packaging`.

Complete usage is below:
```
usage: kicad-to-openpnp-standalone.py [-h] --board BOARD --board_xml BOARD_XML [--openpnp_config OPENPNP_CONFIG] [--no_backup NO_BACKUP]
                                      [--use_mixedcase] [--use_value_for_part_id] [--nozzle NOZZLE] [--ignore_top] [--ignore_bottom]
                                      [--read_only] [--parts_json PARTS_JSON] [--no_summary] [--rounding ROUNDING] [--rotation ROTATION]

options:
  -h, --help            show this help message and exit
  --board BOARD         KiCad PCB to parse, foo.kicad_pcb
  --board_xml BOARD_XML
                        OpenPnP board.xml to generate
  --openpnp_config OPENPNP_CONFIG
                        Location of OpenPnP Configuration files
  --no_backup NO_BACKUP
                        Enabling this option will disable creation of backup copies of packages.xml and parts.xml
  --use_mixedcase       Enabling this option will generate package names and part names using the values as-is from the PCB. When not
                        enabled all names will be forced to upper case.
  --use_value_for_part_id
                        Enabling this option will use component Value from the KiCad PCB footprint as the OpenPnP part ID
  --nozzle NOZZLE       Default nozzle(s) to assign as compatible, can be specified more than once
  --ignore_top          Exclude pads on the F_Cu (top) layer
  --ignore_bottom       Exclude pads on the B_Cu (bottom) layer
  --read_only           Enable this option to disable updating any OpenPnP files, board.xml will still be generated.
  --parts_json PARTS_JSON
                        Location of parts.json
  --no_summary          Enabling this option will skip printing a parts summary after parsing
  --rounding ROUNDING   This option defines how many decimal points should be kept when rounding
  --rotation ROTATION   This option defines the rotation (degrees) difference between KiCad and OpenPnP for the PCB
```
#### Notes for usage on Windows

Running this script on Windows will require a couple steps to be performed before you can successfully run this script.

1. Locate your [KiCad](www.kicad.org) installation, typically `C:\Program Files\KiCad\{version}`.

2. Open a command prompt as administrator and navigate to `C:\Program Files\KiCad\{version}\bin\Scripts`.

3. Execute `pip install packaging` to install the packaging library.

4. Change directories to where you have cloned / downloaded the `kicad-to-openpnp-standalone.py` and `parts.json` files.

5. Execute `C:\Program Files\KiCad\{version}\bin\python.exe kicad-to-openpnp-standalone.py` to verify that everything is working correctly.

6. Execute `C:\Program Files\KiCad\{version}\bin\python.exe kicad-to-openpnp-standalone.py --read_only --board {path to pcb.kicad_pcb} --board_xml {path to where pcb.board.xml should be generated}`. This will confirm that the OpenPnP configuration directory path was correctly located, if not use `--openpnp_config` to provide the correct path.

7. Execute the same command as used in the previous step without `--read_only` to have the script update your OpenPnP configuration files.

### Packages and Parts mappping

[KiCad](www.kicad.org) can use very long package names as part of the PCB file. This
is unfortunately not ideal for usage in [OpenPnP](www.openpnp.org). Additionally,
package size data is not always available from the package name. To combat these
problems `parts.json` has been created with a number of packages. Additional types
can be easily added to the file.

#### parts.json entry format

The parts.json file contains a handful of fields for each component that should be
renamed as part of the import process. A sample entry is below:

```
  {
      "id": "R_2512",
      "alias": [
          "R_2512_6332Metric_Pad1.40x3.35mm_HandSolder",
          "R_2512_6332Metric"
      ],
      "x_mm": 3.2,
      "y_mm": 6.3,
      "z_mm": 0.55
  },
```

The only fields which are required to be present are `id` and `alias`. The `x_mm`,
`y_mm` and `z_mm` fields can be omitted if these are not known or available, when
not specified these will show up as 0mm in [OpenPnP](www.openpnp.org).

Note: The `alias` field can either be a single entry or an array of entries as
seen above.

Additional supported fields:
* use-package-as-part-id - When present with the value of true the package name will be used as part-id
* ignore - Parts that match this entry will be ignored when generating the board.xml file.
* notes - Any extra notes for the entry, this is not used by the script whatsoever.
